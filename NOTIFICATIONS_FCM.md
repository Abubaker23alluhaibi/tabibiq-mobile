# ุฅุดุนุงุฑุงุช FCM ููุญุต ุงูุชููู

## 0. ูููุงุช Firebase (Android ู iOS)

### ุฃูุฏุฑููุฏ (ุฌุงูุฒ)
- **ุงูููู:** `google-services.json`
- **ุงูููุงู:** ูู ุฌุฐุฑ ุงููุดุฑูุน `./google-services.json` (ููููุณุฎ ุฅูู `android/app/google-services.json` ุนูุฏ ุงูุจูุงุก).
- **ุงูุฅุนุฏุงุฏ ูู app.config.ts:** `android.googleServicesFile: './google-services.json'`
- **ููู ุชุญุตู ุนููู:** Firebase Console โ ูุดุฑูุนู (tabibiq-f6ea6) โ ุฅุนุฏุงุฏุงุช ุงููุดุฑูุน โ ุชุทุจูู Android โ ุชุญููู `google-services.json`.

### ุขูููู (ูุญุชุงุฌ ุฅุถุงูุฉ ุงูููู)
- **ุงูููู:** `GoogleService-Info.plist`
- **ุงูููุงู:** ูู ุฌุฐุฑ ุงููุดุฑูุน ุจุฌุงูุจ `google-services.json`ุ ุฃู: `./GoogleService-Info.plist`
- **ุงูุฅุนุฏุงุฏ ูู app.config.ts:** `ios.googleServicesFile: './GoogleService-Info.plist'` (ุชูุช ุฅุถุงูุชู)
- **ููู ุชุญุตู ุนููู:**
  1. Firebase Console โ ููุณ ุงููุดุฑูุน (tabibiq-f6ea6) โ ุฅุถุงูุฉ ุชุทุจูู โ ุงุฎุชุฑ **iOS**.
  2. ุฃุฏุฎู **Bundle ID:** `com.tabibiq.platform` (ููุณ ุงููููุฉ ูู app.config: `ios.bundleIdentifier`).
  3. ุญููู ููู **GoogleService-Info.plist** ูุถุนู ูู ูุฌูุฏ ุงููุดุฑูุน (ุงูุฌุฐุฑ) ุจุงุณู `GoogleService-Info.plist`.
  4. ูุชูุนูู ุงูุฅุดุนุงุฑุงุช ุนูู iOS ุชุญุชุงุฌ ุฃูุถุงู ุฑูุน **ููุชุงุญ APNs** ูู Firebase: Firebase Console โ ุฅุนุฏุงุฏุงุช ุงููุดุฑูุน โ Cloud Messaging โ ุชุทุจูู iOS โ ุฑูุน APNs Authentication Key (ูู Apple Developer).

**ููุฎุต ุงูููุงูุน:**
| ุงูููุตุฉ  | ุงุณู ุงูููู                 | ุงููุณุงุฑ ูู ุงููุดุฑูุน           |
|--------|----------------------------|------------------------------|
| Android | google-services.json       | `./google-services.json`     |
| iOS     | GoogleService-Info.plist   | `./GoogleService-Info.plist` |

ุจุฏูู ูุถุน `GoogleService-Info.plist` ูู ุงูุฌุฐุฑุ ุจูุงุก iOS ูุฏ ููุดูุ ุจุนุฏ ุชุญูููู ูู Firebase ุถุนู ูู ุงูุฌุฐุฑ ุซู ุฃุนุฏ ุงูุจูุงุก.

---

## 1. ุฃูู ููุญูุธ FCM Tokenุ

- **ูุง ููุญูุธ ุฏุงุฎู ูุณุชูุฏ User.** ูุณุชูุฏ ุงููุณุชุฎุฏู (ูุซู `b@b.b` ุฃู `697b472a7e732d426459931d`) **ูุง ูุญุชูู ุฃุจุฏุงู** ุนูู ุญูู `fcmToken` โ ููุฐุง ูุชุนููุฏ.
- **ููุญูุธ ูู ูุฌููุนุฉ ูููุตูุฉ:** `NotificationToken` (ูู MongoDB: **notificationtokens**).
- ูู ุณุฌู ููู: `token`, `platform`, `userId` ุฃู `doctorId`, `isActive`, `lastUsed`, `createdAt`.

## 1.1 ูุชู ููุณุฌูู ุงูุชููู ูู ุงูุชุทุจููุ

- **ุจุนุฏ ุชุณุฌูู ุงูุฏุฎูู:** ุนูุฏ ุงุณุชุฏุนุงุก `signIn` ูุชู ุงุณุชุฏุนุงุก `registerForUserNotifications(userId)` ุฃู `registerForDoctorNotifications(doctorId)` ููุฑุงู.
- **ุจุนุฏ ุฅูุดุงุก ุญุณุงุจ:** ูุฃู `signUp` ูุณุฌูู ุงูุฏุฎูู ุชููุงุฆูุงู ุซู ูุณุชุฏุนู `signIn`ุ ูุฅู ุงูุชููู ููุฑุณู ุจุนุฏ ุฅูุดุงุก ุงูุญุณุงุจ ูุจุงุดุฑุฉ (ููุณ ุงูุฎุทูุฉ 4 ุฃุนูุงู).
- **ุนูุฏ ูุชุญ ุงูุชุทุจูู:** ุฅุฐุง ููุฌุฏ ูุณุชุฎุฏู ูุณุฌููุ ุชูุณุชุฏุนู `registerForNotifications()` ุงูุชู ุชุฑุณู ุงูุชููู ูุน `userId`/`doctorId`.
- ุฅุฐุง ูู ูุธูุฑ ุณุฌู ูู **notificationtokens** ูููุณุชุฎุฏู ุงูุฌุฏูุฏุ ูุบุงูุจุงู: ุงูุชุทุจูู ูุนูู ูู **Expo Go** (ูุง ูุฏุนู FCM ูู SDK 53)ุ ุฃู ูู ููููุญ ุฅุฐู ุงูุฅุดุนุงุฑุงุช ุจุนุฏ. ุงุณุชุฎุฏู **Development Build** ูุงุฎุชุจุงุฑ ุงูุฅุดุนุงุฑุงุช.

## 2. ููู ุชุชุฃูุฏ ุฃู ุงูุชููู ููุณุฌููุ

### ูู ุงูุจุงููุฏ (ุงูุณุฌูุงุช)

ุนูุฏ ุงุณุชุฏุนุงุก ุงูุชุทุจูู ูู `POST /notifications/register` ูุน `userId` ุฃู `doctorId` ุณุชุธูุฑ ูู ุงูููุฌ ุฃุณุทุฑ ูุซู:

- `โ ุชู ุชุณุฌูู/ุชุญุฏูุซ ุฑูุฒ ุงูุฅุดุนุงุฑุงุช: android - ...`
- `๐ฑ FCM token linked to user: 697b44c48b83c88f80fc1103`

### ูู ุงูู API

- **ูุญุต ูุฌูุฏ ุชููู ููุณุชุฎุฏู:**
  ```http
  GET https://web-production-78766.up.railway.app/notifications/check-token?userId=697b44c48b83c88f80fc1103
  ```
- ุฅุฐุง ููุฌุฏ ุชููู: `hasToken: true` ูุน `platform`, `tokenPrefix`, `createdAt`.
- ุฅุฐุง ูู ููุณุฌูู: `hasToken: false`.

### ูู MongoDB

- ุงูุชุญ ูุฌููุนุฉ **notificationtokens** (ุฃู ุงูุงุณู ุงูุฐู ูุณุชุฎุฏูู ูุดุฑูุนู).
- ุงุจุญุซ ุนู `userId: ObjectId("697b44c48b83c88f80fc1103")` ุฃู `doctorId` ุงูููุงุณุจ.
- ุฅุฐุง ูุฌุฏุช ุณุฌูุงู ูุน `isActive: true` ูุงูุชููู ููุณุฌูู.

## 3. ุฎุทุฃ "SenderId mismatch"

ูุญุฏุซ ุนูุฏูุง:

- **ุงูุชุทุจูู** ูููุฏ ุงูุชููู ุจุงุณุชุฎุฏุงู ูุดุฑูุน Firebase ูุนููู (ูู `google-services.json`: `project_id: "tabibiq-f6ea6"`, `project_number: "1018352493043"`).
- **ุงูุจุงููุฏ** ูุฑุณู ุงูุฅุดุนุงุฑุงุช ุจุงุณุชุฎุฏุงู ูุดุฑูุน Firebase ุขุฎุฑ (ููู service account ุฃู ูุชุบูุฑุงุช ุจูุฆุฉ ูุฎุชููุฉ).

**ุงูุญู:**

- ุชุฃูุฏ ุฃู ุงูุจุงููุฏ ูุณุชุฎุฏู **ููุณ ุงููุดุฑูุน**: `tabibiq-f6ea6`.
- ุนูู Railway (ุฃู ุงูุณูุฑูุฑ): `FIREBASE_PROJECT_ID` = `tabibiq-f6ea6` ูููู service account ูู ููุณ ุงููุดุฑูุน.
- ุนูุฏ ุงูุชุดุบููุ ุงูุจุงููุฏ ูุทุจุน `project_id`ุ ูุงุฑูู ูุน `project_id` ุฏุงุฎู `google-services.json` ูู ุงูุชุทุจูู.

## 4. Expo Go ู Push

- ูู **Expo Go** ูุน **SDK 53**ุ ุงูุฅุดุนุงุฑุงุช ุงูุจุนูุฏุฉ (Remote Push) ุบูุฑ ูุฏุนููุฉ.
- ุงูุฑุณุงูุฉ: *"Android Push notifications functionality was removed from Expo Go with SDK 53"* ุชุนูู ุฃู ุงูุชููู ุฃู ุงูุฅุฑุณุงู ูุฏ ูุง ูุนููุงู ุจุดูู ุตุญูุญ ูู Expo Go.
- ูุงุฎุชุจุงุฑ ุงูุฅุดุนุงุฑุงุช ูุนููุงู ุงุณุชุฎุฏู **Development Build** (ูุซูุงู `npx expo run:android` ุฃู `eas build`)ุ ูููุณ Expo Go.

## 5. ููุงุฐุง ุงูุญุณุงุจ ุงูุฌุฏูุฏ ูุง ูุณุฌู ุชููููุ (ุขุฎุฑ ุชููู ูู DB ูุฏูู)

ุฅุฐุง ุขุฎุฑ ุณุฌู ูู **notificationtokens** ูู ููู ุณุงุจู (ูุซู 2026-01-28) ููุง ูุธูุฑ ุณุฌู ุฌุฏูุฏ ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู ุจุญุณุงุจ ุฌุฏูุฏ:

1. **ุดุบูู ุงูุชุทุจูู ูุณุฌูู ุฏุฎูู ุจุงูุญุณุงุจ ุงูุฌุฏูุฏ** ูุฑุงูุจ **ูููุณูู ุงูุชุทุจูู** (Metro / terminal ุฃู React Native Debugger):
   - ูุฌุจ ุฃู ุชุฑู: `๐ [FCM] ุฌุงุฑู ุชุณุฌูู ุชููู ุงูุฅุดุนุงุฑุงุช ูููุณุชุฎุฏู: <userId>`
   - ุซู ูุงุญุฏุฉ ูู:
     - `๐ [FCM] ูุญุงููุฉ ุชุณุฌูู ุงูุชููู ูููุณุชุฎุฏู` โ `๐ [FCM] ุชู ุงูุญุตูู ุนูู ุงูุชูููุ ุฌุงุฑู ุงูุฅุฑุณุงู ููุณูุฑูุฑ` โ `๐ [FCM] ุชู ุฅุฑุณุงู ุงูุชููู ููุณูุฑูุฑ ุจูุฌุงุญ` โ **ุงูุชููู ููุฑุณู ูุนูุงู**
     - `๐ [FCM] ูุฌุจ ุชุดุบูู ุงูุชุทุจูู ุนูู ุฌูุงุฒ ุญูููู (Expo Go ูุง ูุฏุนู FCM ูู SDK 53)` โ **ุฃูุช ุนูู Expo Go โ ูุง ููุฌุฏ ุชููู FCM**
     - `๐ [FCM] ูู ูุชู ููุญ ุฅุฐู ุงูุฅุดุนุงุฑุงุช` โ **ูู ุชูููุญ ุตูุงุญูุฉ ุงูุฅุดุนุงุฑุงุช**
     - `๐ [FCM] ูุดู getDevicePushTokenAsync` โ **Expo Go ุฃู ูุญุงูู โ ูุง ููุฌุฏ ุชููู**
     - `๐ [FCM] ูุดู ุฅุฑุณุงู ุงูุชููู ุฅูู ุงูุฎุงุฏู` ูุน status โ **ุงูุทูุจ ูุดู (ุดุจูุฉ ุฃู ุงูุณูุฑูุฑ ุฑูุถ)**
2. **ุฑุงูุจ ููุฌ Railway** ุนูุฏ ููุณ ูุญุธุฉ ุชุณุฌูู ุงูุฏุฎูู:
   - ุฅุฐุง ุธูุฑ `POST /notifications/register` ู `โ ุชู ุชุณุฌูู/ุชุญุฏูุซ ุฑูุฒ ุงูุฅุดุนุงุฑุงุช` ู `๐ฑ FCM token linked to user: <userId>` โ ุงูุทูุจ ูุตู ูุงูุชููู ููุณุฌูู.
   - ุฅุฐุง **ูู ูุธูุฑ** ุฃู ูู ุฐูู โ ุงูุชุทุจูู ูู ูุฑุณู ุงูุทูุจ (ุบุงูุจุงู Expo Go ุฃู ูุดู ุฌูุจ ุงูุชููู ุฃู ุฅุฐู).

**ุงูุฎูุงุตุฉ:** ุฅุฐุง ููุช ุนูู **Expo Go** ููู ููุณุฌูู ุฃู ุชููู ุฌุฏูุฏ. ุงุณุชุฎุฏู **Development Build** (ูุซูุงู `npx expo run:android` ุฃู APK ูู EAS) ุนูู ุฌูุงุฒ ุญููููุ ูููุญ ุฅุฐู ุงูุฅุดุนุงุฑุงุชุ ุซู ุณุฌูู ุฏุฎูู โ ุนูุฏูุง ูุฌุจ ุฃู ูุธูุฑ ุณุฌู ุฌุฏูุฏ ูู **notificationtokens** ุจุชุงุฑูุฎ ุงูููู.

## 6. ููุงุฐุง ูุง ูุธูุฑ ุชููู ุฌุฏูุฏ ุนูุฏ ุชุณุฌูู ุงูุฏุฎููุ (ุชูุตูู ุชููู)

ุฅุฐุง ุณุฌููุช ุฏุฎููุงู ุฃูุซุฑ ูู ูุฑุฉ ููุง ูุธูุฑ ุณุฌู ุฌุฏูุฏ ูู **notificationtokens**:

| ุงูุณุจุจ | ูุงุฐุง ุชุฑู ูู ูููุณูู ุงูุชุทุจูู (Logs) |
|--------|-----------------------------------|
| **ุชุดุบูู ูู Expo Go** | `ูุดู getDevicePushTokenAsync` ุฃู `Expo Go ูุง ูุฏุนู FCM ูู SDK 53` โ **ุงูุญู:** ุงุณุชุฎุฏู Development Build (`npx expo run:android` ุฃู APK ูู EAS). |
| **ูู ููููุญ ุฅุฐู ุงูุฅุดุนุงุฑุงุช** | `ูู ูุชู ููุญ ุฅุฐู ุงูุฅุดุนุงุฑุงุช โ ูู ููุณุฌูู ุงูุชููู` โ **ุงูุญู:** ุงุณูุญ ุจุงูุฅุดุนุงุฑุงุช ูู ุฅุนุฏุงุฏุงุช ุงูุชุทุจูู/ุงูุฌูุงุฒ. |
| **ุทูุจ ุงูุณูุฑูุฑ ูุดู** | `ูุดู ุฅุฑุณุงู ุงูุชููู ุฅูู ุงูุฎุงุฏู` ูุน status ุฃู body โ **ุงูุญู:** ุฑุงุฌุน CORSุ ุงูุฑุงุจุทุ ูุณุฌูุงุช Railway. |
| **ุงูุณูุฑูุฑ ูู ูุณุชูุจู ุงูุทูุจ** | ูุง ูุธูุฑ ูู ุณุฌูุงุช Railway ุณุทุฑ `โ ุชู ุชุณุฌูู/ุชุญุฏูุซ ุฑูุฒ ุงูุฅุดุนุงุฑุงุช` โ ุงูุชุทุจูู ุฅูุง ูู ูุญุตู ุนูู ุชููู (Expo Go) ุฃู ุงูุทูุจ ูู ูุตู. |

**ุชุญูู ูู ุณุฌูุงุช Railway:** ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู ูู ุงูุชุทุจููุ ูุฌุจ ุฃู ูุธูุฑ ูู ุงูููุฌ:  
`โ ุชู ุชุณุฌูู/ุชุญุฏูุซ ุฑูุฒ ุงูุฅุดุนุงุฑุงุช` ู `๐ฑ FCM token linked to user: <userId>`.  
ุฅุฐุง ูู ูุธูุฑุ ุงูุชุทุจูู ูู ูุฑุณู ุงูุชููู (ุบุงูุจุงู Expo Go ุฃู ุฅุฐู ุฃู ุฎุทุฃ ูู getDevicePushTokenAsync).

## 7. ููุฎุต ุณุฑูุน

| ูุงุฐุง ุชุฑูุฏ | ุฃูู ุชูุธุฑ |
|-----------|----------|
| ูู ุงูุชููู ููุณุฌูู ูููุณุชุฎุฏูุ | ูุฌููุนุฉ **notificationtokens** ุฃู `GET /notifications/check-token?userId=...` |
| ููุงุฐุง ูุง ูุตู ุงูุฅุดุนุงุฑุ | ุชุญูู: 1) ูุฌูุฏ ุชููู ูุฑุชุจุท ุจู userIdุ 2) ุชุทุงุจู project_id (ูุง SenderId mismatch)ุ 3) ุงูุชุดุบูู ูู development build ูููุณ Expo Go |
| ููุงุฐุง ูุง ูุธูุฑ ุชููู ุฌุฏูุฏ ุจุนุฏ ุงูุฏุฎููุ | ุฑุงุฌุน ูููุณูู ุงูุชุทุจูู ูุฑุณุงุฆู `๐ [FCM]` โ ุฅู ุธูุฑ "Expo Go" ุฃู "ูู ูุชู ููุญ ุฅุฐู" ูุงููุดููุฉ ูู ุงูุชุทุจูู/ุงูุฌูุงุฒุ ูุฅู ูู ูุธูุฑ ูู Railway "ุชู ุชุณุฌูู ุฑูุฒ ุงูุฅุดุนุงุฑุงุช" ูุงูุชููู ูู ููุฑุณูู ููุณูุฑูุฑ |
